const fs = require('fs');
const path = require('path');

// ANSI color codes for console output
const colors = {
  reset: '\x1b[0m',
  bright: '\x1b[1m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  blue: '\x1b[36m',
  red: '\x1b[31m'
};

function log(message, color = colors.reset) {
  console.log(`${color}${message}${colors.reset}`);
}

function logSection(title) {
  log('\n' + '='.repeat(60), colors.blue);
  log(`  ${title}`, colors.bright + colors.blue);
  log('='.repeat(60), colors.blue);
}

function logSuccess(message) {
  log(`âœ… ${message}`, colors.green);
}

function logWarning(message) {
  log(`âš ï¸  ${message}`, colors.yellow);
}

function logError(message) {
  log(`âŒ ${message}`, colors.red);
}

// Configuration
const FRONTEND_CONSTANTS_DIR = path.join(process.cwd(), 'src', 'constants');
const BACKEND_SHARED_DIR = path.join(process.cwd(), 'supabase', 'functions', '_shared');

// Files to sync (frontend SSOT â†’ backend mirror)
const FILES_TO_SYNC = [
  'ageGroups.ts',
  'lessonStructure.ts',
  'teacherPreferences.ts',
  'theologyProfiles.ts',
];

function generateHeader(sourceFile) {
  return `/**
 * âš ï¸  AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
 * 
 * This file is automatically generated from the frontend SSOT.
 * Source: src/constants/${sourceFile}
 * 
 * To make changes:
 * 1. Edit the source file in src/constants/
 * 2. Run: npm run sync-constants
 * 3. Commit both files (frontend source + backend mirror)
 * 
 * Generated: ${new Date().toISOString()}
 * Generator: scripts/sync-constants.cjs
 * Architecture: Frontend Drives Backend (Master Vision Principle)
 */

`;
}

function syncFile(fileName) {
  const frontendPath = path.join(FRONTEND_CONSTANTS_DIR, fileName);
  const backendPath = path.join(BACKEND_SHARED_DIR, fileName);

  if (!fs.existsSync(frontendPath)) {
    logWarning(`Frontend source not found: ${fileName} (skipping)`);
    return false;
  }

  try {
    const frontendContent = fs.readFileSync(frontendPath, 'utf8');
    const header = generateHeader(fileName);
    const backendContent = header + frontendContent;

    if (!fs.existsSync(BACKEND_SHARED_DIR)) {
      fs.mkdirSync(BACKEND_SHARED_DIR, { recursive: true });
    }

    fs.writeFileSync(backendPath, backendContent, 'utf8');
    logSuccess(`Synced: ${fileName}`);
    return true;

  } catch (error) {
    logError(`Failed to sync ${fileName}: ${error.message}`);
    return false;
  }
}

function verifyDirectories() {
  const checks = [
    { path: FRONTEND_CONSTANTS_DIR, name: 'Frontend constants directory' },
    { path: BACKEND_SHARED_DIR, name: 'Backend shared directory' }
  ];

  let allExist = true;

  for (const check of checks) {
    if (fs.existsSync(check.path)) {
      logSuccess(`${check.name} exists`);
    } else {
      logWarning(`${check.name} not found - will create if needed`);
      allExist = false;
    }
  }

  return allExist;
}

function main() {
  logSection('Build-Time Constants Synchronization');
  
  log('\nArchitecture: Frontend Drives Backend');
  log('Source: src/constants/ (SSOT - Single Source of Truth)');
  log('Target: supabase/functions/_shared/ (Auto-generated mirrors)\n');

  logSection('Directory Verification');
  verifyDirectories();

  logSection('Synchronizing Constants');
  
  let successCount = 0;
  let skipCount = 0;
  let failCount = 0;

  for (const fileName of FILES_TO_SYNC) {
    const frontendPath = path.join(FRONTEND_CONSTANTS_DIR, fileName);
    
    if (!fs.existsSync(frontendPath)) {
      log(`â­ï¸  Skipping ${fileName} (not yet created)`, colors.yellow);
      skipCount++;
    } else {
      const success = syncFile(fileName);
      if (success) {
        successCount++;
      } else {
        failCount++;
      }
    }
  }

  logSection('Synchronization Summary');
  log(`Total files configured: ${FILES_TO_SYNC.length}`);
  logSuccess(`Successfully synced: ${successCount}`);
  if (skipCount > 0) {
    logWarning(`Skipped (not created yet): ${skipCount}`);
  }
  if (failCount > 0) {
    logError(`Failed: ${failCount}`);
  }

  log('\n' + '='.repeat(60) + '\n');

  if (failCount > 0) {
    logError('Synchronization completed with errors');
    process.exit(1);
  } else if (successCount > 0) {
    logSuccess('Synchronization completed successfully');
    log('\nNext steps:');
    log('1. Review generated files in supabase/functions/_shared/');
    log('2. Commit both frontend source and backend mirror files');
    log('3. Deploy backend: npx supabase functions deploy generate-lesson --project-ref hphebzdftpjbiudpfcrs\n');
  } else {
    logWarning('No files were synced (all skipped)');
    log('\nThis is normal if you haven\'t created frontend SSOT files yet.');
    log('Create files in src/constants/ and run this script again.\n');
  }
}

main();