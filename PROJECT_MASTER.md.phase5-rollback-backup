# LessonSparkUSA Master Project Document

**Last Updated:** November 23, 2025
**Current Phase:** Phase 5 - INCOMPLETE/FAILED
**Next Action:** Restart Phase 5 with systematic approach
**Project Owner:** Lynn (Admin)
**Tech Stack:** React/TypeScript (Lovable.dev), Supabase Edge Functions, PostgreSQL, Stripe, Claude/Anthropic API, GitHub, Netlify, PowerShell

---

## COMPREHENSIVE VISION (NEVER CHANGES)

✅ True SSOT for fixed structural values
✅ One-location management (add once, works everywhere)
✅ Easy to add new preferences - Change one place, works everywhere
✅ Frontend drives backend (frontend is source of truth)
✅ Freshness: Dynamic, non-repetitive output
✅ Tiered architecture:
- Tier 1: Lesson Plan structure (supreme/foundational, UNCHANGING)
- Tier 2: Customizations (theological preferences, user preferences)

✅ All actions support potential export from Lovable.dev
✅ Keep logic in Supabase Edge Functions (portable) and local repository
✅ Avoid Lovable-specific dependencies
✅ Christian values guide all development decisions

---

## GOVERNANCE MODEL

| Principle | Implementation |
|-----------|----------------|
| **Admin controls boundaries** | Lynn manages all constants files; only admin can add/remove/modify options |
| **Users select, not create** | Dropdowns populated from constants; no free-form structural input |
| **Frontend is SSOT** | Constants live in src/constants/; synced to backend via script |
| **Claude creative within bounds** | AI generates fresh content but MUST follow Tier 1 structure and Tier 2 parameters |
| **Export-ready architecture** | All logic portable; no Lovable-specific dependencies |

---

## TIERED ARCHITECTURE

**Tier 1 – Supreme/Foundational (UNCHANGING)**
- **8-Section Lesson Structure** (v2.0.0)
- Section names, order, descriptions, required elements, word budgets
- Redundancy locks prevent content duplication
- These NEVER change based on user input

**Tier 2 – Customizations (User Selects from Admin Options)**
- Age Groups (with teaching profiles)
- Theological Preferences (4 Baptist traditions)
- SB Confession Versions (BFM 1963, BFM 2000)
- Bible Versions
- Teacher Preferences (class size, learning styles, etc.)
- Language Options

**Tier 3 – Perpetual Freshness**
- Claude generates creative content WITHIN Tier 1 structure
- Same structure, fresh illustrations/examples/wording each time
- User's Tier 2 selections shape the creative boundaries

---

## IMPLEMENTATION PHASES

### Phase 0: Foundation ✅ COMPLETE

| # | Task | Status | Dependencies | Notes |
|---|------|--------|--------------|-------|
| 0.1 | Create src/constants/ directory structure | ✅ Complete | None | |
| 0.2 | Create src/constants/index.ts (single export point) | ✅ Complete | 0.1 | |
| 0.3 | Create src/constants/contracts.ts (TypeScript interfaces) | ✅ Complete | 0.1 | |
| 0.4 | Create sync-constants.ps1 script | ✅ Complete | 0.1 | |
| 0.5 | Create validate-constants.ps1 script | ✅ Complete | 0.3 | |
| 0.6 | Create deploy.ps1 automation script | ✅ Complete | 0.4, 0.5 | |
| 0.7 | Test foundation scripts work correctly | ✅ Complete | 0.6 | PHASE GATE ✅ |

### Phase 1: Lesson Structure SSOT ✅ COMPLETE

| # | Task | Status | Dependencies | Notes |
|---|------|--------|--------------|-------|
| 1.1 | Create src/constants/lessonStructure.ts | ✅ Complete | Phase 0 | |
| 1.2 | Define LessonSection interface in contracts.ts | ✅ Complete | 0.3 | Done in Phase 0.3 |
| 1.3 | Add version tag to lesson structure | ✅ Complete | 1.1 | LESSON_STRUCTURE_VERSION |
| 1.4 | Update Edge Function to receive structure from request | ✅ Complete | 1.1 | Imports from _shared |
| 1.5 | Update Edge Function to build prompt from received structure | ✅ Complete | 1.4 | buildLessonStructurePrompt() |
| 1.6 | Update EnhanceLessonForm to import and send structure | ✅ Complete | 1.1 | Backend pulls from SSOT |
| 1.7 | Add explicit "MUST include ALL sections" instruction | ✅ Complete | 1.5 | |
| 1.8 | Increase max_tokens to 8000 | ✅ Complete | 1.5 | |
| 1.9 | Test lesson generation includes all 12 sections | ✅ Complete | 1.8 | |
| 1.10 | Verify Student Handout (Section 11) generates | ✅ Complete | 1.9 | PHASE GATE ✅ |

### Phase 2: Age Groups SSOT ✅ COMPLETE

| # | Task | Status | Dependencies | Notes |
|---|------|--------|--------------|-------|
| 2.1 | Create src/constants/ageGroups.ts | ✅ Complete | Phase 1 | Nov 21, 2025 |
| 2.2 | Define AgeGroup interface with teaching profile | ✅ Complete | 0.3 | Done in Phase 0.3 |
| 2.3 | Migrate options from src/lib/constants.ts | ✅ Complete | 2.1 | |
| 2.4 | Migrate descriptions from src/lib/constants.ts | ✅ Complete | 2.1 | |
| 2.5 | Migrate teaching profiles from Edge Function | ✅ Complete | 2.1 | |
| 2.6 | Implement ID + Lookup pattern | ✅ Complete | 2.5 | |
| 2.7 | Update Edge Function to lookup by ID | ✅ Complete | 2.6 | |
| 2.8 | Update EnhanceLessonForm to send ID only | ✅ Complete | 2.6 | |
| 2.9 | Add fallback defaults | ✅ Complete | 2.7 | |
| 2.10 | Remove old src/lib/constants.ts age group code | ✅ Complete | 2.8 | |
| 2.11 | Remove old _shared/constants.ts age group code | ✅ Complete | 2.8 | |
| 2.12 | Test all age groups work correctly | ✅ Complete | 2.11 | PHASE GATE ✅ |

### Phase 3: Theological Preferences SSOT ✅ COMPLETE

| # | Task | Status | Dependencies | Notes |
|---|------|--------|--------------|-------|
| 3.1 | Create src/constants/theologicalPreferences.ts | ✅ Complete | Phase 2 | Nov 21, 2025 |
| 3.2 | Define TheologicalPreference interface | ✅ Complete | 0.3 | Done in Phase 0.3 |
| 3.3 | Define ConfessionVersion interface | ✅ Complete | 0.3 | Done in Phase 0.3 |
| 3.4 | Migrate 4 Baptist traditions from Edge Function | ✅ Complete | 3.1 | |
| 3.5 | Migrate BFM versions from Edge Function | ✅ Complete | 3.1 | |
| 3.6 | Implement ID + Lookup pattern | ✅ Complete | 3.5 | |
| 3.7 | Update Edge Function to lookup by ID | ✅ Complete | 3.6 | |
| 3.8 | Update EnhanceLessonForm to send ID only | ✅ Complete | 3.6 | |
| 3.9 | Add fallback defaults | ✅ Complete | 3.7 | |
| 3.10 | Remove old theologicalLenses from Edge Function | ✅ Complete | 3.8 | |
| 3.11 | Test all theological preferences work correctly | ✅ Complete | 3.10 | PHASE GATE ✅ |

### Phase 4: 8-Section Framework Implementation ✅ COMPLETE

| # | Task | Status | Dependencies | Notes |
|---|------|--------|--------------|-------|
| 4.1 | Create src/constants/lessonSections.ts (8-section SSOT) | ✅ Complete | Phase 3 | Nov 22, 2025 |
| 4.2 | Define LessonSection interface with redundancyLock | ✅ Complete | 4.1 | With future-ready fields |
| 4.3 | Create backend lessonStructure.ts with prompt generators | ✅ Complete | 4.1 | In _shared/ |
| 4.4 | Update Edge Function to use SSOT prompt generation | ✅ Complete | 4.3 | Dynamic structure |
| 4.5 | Add 120-second timeout to EnhanceLessonForm | ✅ Complete | 4.4 | Graceful degradation |
| 4.6 | Implement AbortController for fetch timeout | ✅ Complete | 4.5 | |
| 4.7 | Update toast messages with section count | ✅ Complete | 4.6 | |
| 4.8 | Git commit all changes | ✅ Complete | 4.7 | Commit 05e2d46 |
| 4.9 | Deploy Edge Function to Supabase | ✅ Complete | 4.8 | Deployed successfully |
| 4.10 | Test: John 3:16 generation completes | ✅ Complete | 4.9 | 2.15 min, 8 sections ✅ |
| 4.11 | Test: Topic generation with age-appropriate language | ✅ Complete | 4.10 | 2.21 min, 8 sections ✅ |
| 4.12 | Verify no timeout errors occur | ✅ Complete | 4.11 | PHASE GATE ✅ |

**Phase 4 Results:**
- Generation time: 2.15-2.21 minutes (within 120s timeout)
- All 8 sections complete every time
- No "Failed to Fetch" errors
- Word count: ~2000-2900 (down from ~5000)
- Redundancy eliminated through architectural locks
- Quality maintained with full theological depth

### Phase 5: Theology Profile Migration ❌ FAILED - INCOMPLETE

**Goal:** Migrate from duplicate theology fields to single profile ID system.

**What Was Attempted (Nov 23, 2025):**
- ✅ Database migration: Added theology_profile_id column, migrated 32 lessons
- ✅ Updated contracts.ts with profileId field
- ✅ Created theologicalPreferences.ts with 4 unified profiles
- ⚠️ Partially updated EnhanceLessonForm.tsx (file saved but not deployed by Lovable)
- ❌ Backend lessonStructure.ts incomplete (missing exports causing boot errors)
- ❌ Frontend changes not deployed by Lovable
- ❌ System non-functional

**Critical Failures:**
1. Used piecemeal regex replacements that failed repeatedly
2. Did not verify backend file completeness before deployment
3. Added missing exports one at a time instead of complete file
4. Failed to ensure Lovable deployed frontend changes
5. Violated protocol: did not confirm Master Plan compliance before each step
6. Wasted 3+ hours with repeated failures

**Current System State:**
- Database: ✅ Has theology_profile_id column with migrated data
- Backend SSOT: ❌ Incomplete, missing exports
- Frontend SSOT: ✅ Has profileId in files, but not deployed
- Frontend UI: ❌ Still shows old two-dropdown system
- Edge Function: ❌ Boot errors, non-functional
- **SYSTEM STATUS: BROKEN**

**What Needs to Happen:**
1. Rollback OR complete fix of backend lessonStructure.ts
2. Force Lovable deployment of frontend form changes
3. Systematic testing with proper error handling
4. Phase gate testing before marking complete

| # | Task | Status | Dependencies | Notes |
|---|------|--------|--------------|-------|
| 5.1 | Audit database for theology field usage | ✅ Complete | Phase 4 | 32 lessons found |
| 5.2 | Create theology_profile_id column in lessons table | ✅ Complete | 5.1 | Column added |
| 5.3 | Migrate existing lessons to profile IDs | ✅ Complete | 5.2 | 32 lessons migrated |
| 5.4 | Update contracts.ts with profileId | ✅ Complete | 5.3 | Interface updated |
| 5.5 | Update theologicalPreferences.ts with 4 profiles | ✅ Complete | 5.4 | sb_bfm_1963, sb_bfm_2000, rb, ib |
| 5.6 | Update EnhanceLessonForm.tsx with single dropdown | ⚠️ Partial | 5.5 | File created, not deployed |
| 5.7 | Fix backend lessonStructure.ts exports | ❌ Failed | 5.6 | Multiple missing exports |
| 5.8 | Deploy and test complete system | ❌ Not Started | 5.7 | Cannot test until 5.7 complete |
| 5.9 | Verify all 4 theology profiles work | ❌ Not Started | 5.8 | |
| 5.10 | Phase gate: System functional | ❌ Not Started | 5.9 | PHASE GATE BLOCKED |

---

## KNOWN ISSUES

| # | Issue | Severity | Status | Related Phase | Notes |
|---|-------|----------|--------|---------------|-------|
| 1 | Backend lessonStructure.ts missing exports | Critical | Open | Phase 5 | generateBehaviorRules, generateFullPromptStructure, getTotalMaxWords, others |
| 2 | Frontend form changes not deployed by Lovable | Critical | Open | Phase 5 | EnhanceLessonForm.tsx saved locally but not live |
| 3 | Edge Function boot errors | Critical | Open | Phase 5 | Cannot start due to missing exports |
| 4 | System completely non-functional | Critical | Open | Phase 5 | Cannot generate lessons |
| 5 | Empty section labels in View display | Low | Open | Future | Need SSOT UI integration |

---

## FILES CHANGED TRACKER

| File | Last Changed | Session Date | Status |
|------|--------------|--------------|--------|
| src/constants/contracts.ts | Nov 23, 2025 | Nov 23, 2025 | ⚠️ Has profileId, needs verification |
| src/constants/theologicalPreferences.ts | Nov 23, 2025 | Nov 23, 2025 | ⚠️ Has 4 profiles with profileIds |
| src/components/dashboard/EnhanceLessonForm.tsx | Nov 23, 2025 | Nov 23, 2025 | ⚠️ Complete file saved, NOT deployed |
| supabase/functions/_shared/lessonStructure.ts | Nov 23, 2025 | Nov 23, 2025 | ❌ BROKEN - incomplete exports |
| supabase/functions/_shared/theologicalPreferences.ts | Nov 23, 2025 | Nov 23, 2025 | ⚠️ Synced but not tested |
| supabase/functions/generate-lesson/index.ts | Nov 22, 2025 | Nov 22, 2025 | ⚠️ Works with old theology fields |

---

## CONSTANTS FILES STATUS

| File | Contents | Status |
|------|----------|--------|
| src/constants/index.ts | Exports all constants | ✅ Working |
| src/constants/contracts.ts | TypeScript interfaces | ⚠️ Has profileId, needs verification |
| src/constants/lessonSections.ts | 8-section Tier 1 structure v2.0.0 | ✅ Working |
| src/constants/ageGroups.ts | Age groups + teaching profiles | ✅ Working |
| src/constants/theologicalPreferences.ts | 4 profiles with profileIds | ⚠️ Created, not deployed |
| src/constants/teacherPreferences.ts | All customization options | ⬜ Not Created |
| src/constants/systemOptions.ts | Enhancement types, source types, languages | ⬜ Not Created |
| src/constants/bibleVersions.ts | Moved from bibleTranslations.ts | ⬜ Not Created |

---

## SCRIPTS STATUS

| Script | Purpose | Status |
|--------|---------|--------|
| sync-constants.ps1 | Copy frontend constants to backend _shared | ✅ Working |
| validate-constants.ps1 | Verify constants are valid before deploy | ✅ Working |
| deploy.ps1 | Full deployment automation | ✅ Working |

---

## DATABASE TABLES REFERENCE

| Table | Key Columns | Notes |
|-------|-------------|-------|
| lessons | id, title, original_text, source_type, upload_path, theology_profile_id, filters (jsonb), user_id, organization_id, created_at, updated_at | theology_profile_id added Nov 23, migrated 32 lessons |
| profiles | id, preferred_age_group, preferred_language, org_setup_dismissed | User preferences |
| user_roles | user_id, role, organization_id | Authoritative source for roles |
| organizations | id, name, default_doctrine | Organization settings |

---

## SESSION PROTOCOLS

### Starting a New Chat
1. Paste this entire document into the new chat
2. Wait for Claude to confirm understanding
3. Claude should state:
   - Current Phase
   - Last completed task
   - Next action to take
4. Confirm or correct before proceeding
5. Work ONLY on the next checklist item

### During a Session
1. Complete tasks in order – no skipping ahead
2. Test each change before marking complete
3. Note any issues discovered in KNOWN ISSUES
4. Update FILES CHANGED TRACKER for every file modified

### Ending a Session
1. Claude provides updated PROJECT_MASTER.md
2. Update all checkboxes for completed items
3. Update CURRENT SESSION WORK LOG
4. Save to local repository: C:\Users\Lynn\lesson-spark-usa\PROJECT_MASTER.md
5. Optionally commit to GitHub for version history

### Phase Gates
Before moving to next phase:
1. ALL items in current phase must be ✅ Complete
2. System must be tested and working
3. No regressions introduced
4. Lynn confirms approval to proceed

---

## CURRENT SESSION WORK LOG

### Session: November 23, 2025 (Morning) - FAILED

**Focus:** Phase 5 - Theology Profile Migration

**What Was Attempted:**
- Database migration to theology_profile_id (successful)
- Added profileId to contracts.ts interface
- Created theologicalPreferences.ts with 4 unified profiles
- Created complete EnhanceLessonForm.tsx with single dropdown
- Attempted to fix backend lessonStructure.ts exports

**What Failed:**
- Backend lessonStructure.ts incomplete (missing multiple exports)
- Piecemeal regex replacements to frontend form failed repeatedly
- Frontend form changes not deployed by Lovable
- Edge Function non-functional due to missing exports
- System completely broken - cannot generate lessons

**Critical Errors Made:**
1. Did not verify Master Plan compliance before each step
2. Used unreliable regex replacements instead of complete file replacements
3. Added exports one at a time instead of creating complete file
4. Did not verify backend completeness before deployment
5. Violated established protocols repeatedly
6. Wasted 3+ hours with repeated failures

**System State at End of Session:**
- ❌ Backend broken (missing exports)
- ❌ Frontend not deployed
- ❌ System non-functional
- ✅ Database migration complete (only success)

**Next Session Must:**
1. **FIRST:** Decide whether to rollback Phase 5 or complete it
2. If completing: Create COMPLETE backend lessonStructure.ts with ALL exports
3. Force Lovable deployment or manually update via Lovable UI
4. Test systematically before marking anything complete
5. Follow protocols strictly - verify Master Plan compliance at each step

---

## ARCHITECTURAL DECISIONS LOG

| Date | Decision | Rationale |
|------|----------|-----------|
| Nov 21, 2025 | Frontend constants are SSOT | Follows "frontend drives backend" principle |
| Nov 21, 2025 | Admin controls all boundaries | Users select from options, cannot create new ones |
| Nov 21, 2025 | ID + Lookup pattern for requests | Smaller payloads, prevents malformed data |
| Nov 21, 2025 | Sync script for backend constants | True SSOT with automated sync |
| Nov 21, 2025 | Teaching profiles belong in frontend | Part of age group constants, admin-controlled |
| Nov 21, 2025 | Deno-compatible version for backend | Backend needs separate file without TypeScript imports |
| Nov 21, 2025 | Defer UI empty labels fix | Proper fix requires SSOT UI integration |
| Nov 22, 2025 | Reduce from 12 to 8 sections | Solve timeout by reducing ~5000 to ~2900 words |
| Nov 22, 2025 | Redundancy locks prevent duplication | Architectural solution vs AI prompting |
| Nov 22, 2025 | 120-second frontend timeout | Graceful degradation, lesson still saves |
| Nov 22, 2025 | Compress vs truncate sections | Maintain quality while reducing length |
| Nov 23, 2025 | Rollback Phase 5 attempt | Failed implementation, multiple critical errors |

---

## QUICK REFERENCE: The 8-Section Lesson Structure (Tier 1 v2.0.0)

1. Lens + Lesson Overview (150-250 words)
2. Learning Objectives + Key Scriptures (150-250 words)
3. Theological Background (Deep-Dive) (450-600 words) - **All theology lives here**
4. Opening Activities (120-200 words)
5. Main Teaching Content (Teacher Transcript) (450-600 words) - **Spoken dialogue**
6. Interactive Activities (150-250 words)
7. Discussion & Assessment (200-300 words)
8. Student Handout (Standalone) (250-400 words) - **Creatively distinct**

**Total Target:** 1920-2900 words (down from ~5000)

**Redundancy Locks:**
- Sections 4, 5, 6, 7, 8 must NOT repeat Section 3 theology
- Section 8 must be creatively distinct from all teacher content

---

## QUICK REFERENCE: Theological Profiles (Tier 2)

**Target State (Not Yet Implemented):**
- sb_bfm_1963: Southern Baptist (BF&M 1963)
- sb_bfm_2000: Southern Baptist (BF&M 2000)
- rb: Reformed Baptist
- ib: Independent Baptist

**Current State (Working):**
- southern_baptist + bfm_1963
- southern_baptist + bfm_2000
- reformed_baptist
- independent_baptist

---

## QUICK REFERENCE: Age Groups (Tier 2)

1. Preschoolers (Ages 3-5)
2. Elementary Kids (Ages 6-10)
3. Preteens & Middle Schoolers (Ages 11-14)
4. High School Students (Ages 15-18)
5. College & Early Career (Ages 19-25)
6. Young Adults (Ages 26-35)
7. Mid-Life Adults (Ages 36-50)
8. Experienced Adults (Ages 51-65)
9. Active Seniors (Ages 66-75)
10. Senior Adults (Ages 76+)
11. Mixed Groups

---

## EMERGENCY RECOVERY

**Current Situation:** System is BROKEN after failed Phase 5 attempt.

**Option 1: Rollback to Phase 4**
```powershell
# Rollback code
git checkout 05e2d46

# Rollback database
# Run in Supabase SQL Editor:
ALTER TABLE lessons DROP COLUMN theology_profile_id;
ALTER TABLE lessons DROP COLUMN updated_at;

# Redeploy
npx supabase functions deploy generate-lesson --project-ref hphebzdftpjbiudpfcrs
```

**Option 2: Complete Phase 5 Properly**
1. Create COMPLETE backend lessonStructure.ts with ALL exports
2. Verify file completeness BEFORE deployment
3. Force Lovable deployment of frontend changes
4. Test systematically

**Last Known Good State:**
- Commit: 05e2d46 (Phase 4 complete, Nov 22, 2025)
- Database: No theology_profile_id column
- System: Fully functional with 8-section framework

---

## CONTACT & RESOURCES

- **Supabase Dashboard:** https://supabase.com/dashboard/project/hphebzdftpjbiudpfcrs
- **Netlify Dashboard:** https://app.netlify.com/projects/lesson-spark-usa
- **Live Site:** https://lessonsparkusa.com
- **GitHub Repo:** https://github.com/lynn75965/lesson-spark-usa
- **Local Path:** C:\Users\Lynn\lesson-spark-usa

---

**END OF MASTER DOCUMENT**

*This document is the Single Source of Truth for project continuity.*
*Update at the end of every session.*
*Paste at the start of every new chat.*
